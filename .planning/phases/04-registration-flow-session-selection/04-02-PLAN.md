---
phase: 04-registration-flow-session-selection
plan: "02"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/components/intro/session-picker.tsx
  - src/components/intro/registration-form.tsx
  - src/actions/register.ts
  - src/app/(landing)/intro/page.tsx
autonomous: true
requirements:
  - INTRO-12

must_haves:
  truths:
    - "Visitor sees 2-3 session cards above the registration form, can tap/click to select one"
    - "Selected card shows highlighted border (brand primary) and a checkmark icon"
    - "On mobile, session cards stack vertically; on desktop they appear in a row"
    - "Selecting a session persists through validation errors — state is not lost on form re-render"
    - "After successful validation, server action redirects to /intro/confirmation?session={id}"
  artifacts:
    - path: "src/components/intro/session-picker.tsx"
      provides: "Card-based session selector client component"
      exports: ["SessionPicker"]
    - path: "src/components/intro/registration-form.tsx"
      provides: "Registration form with session picker and hidden sessionId input"
      contains: "sessionId"
    - path: "src/actions/register.ts"
      provides: "Server action that validates sessionId and redirects to confirmation"
      contains: "redirect"
  key_links:
    - from: "src/components/intro/registration-form.tsx"
      to: "src/components/intro/session-picker.tsx"
      via: "renders SessionPicker above form fields, shares selectedSessionId state"
      pattern: "SessionPicker"
    - from: "src/components/intro/registration-form.tsx"
      to: "src/actions/register.ts"
      via: "hidden input name='sessionId' passes value through FormData"
      pattern: "name=\"sessionId\""
    - from: "src/actions/register.ts"
      to: "/intro/confirmation"
      via: "redirect() called after successful validation, outside any try/catch"
      pattern: "redirect\\("
---

<objective>
Build the session picker UI and wire session selection through the registration form to the server action redirect.

Purpose: INTRO-12 requires visitors to choose from 2-3 upcoming sessions. The session picker must integrate seamlessly with the existing form — selected session ID flows as a hidden input through FormData to the server action, which then redirects to the confirmation page on success.

Output: `session-picker.tsx` (new), updated `registration-form.tsx` with picker + hidden input, updated `register.ts` with sessionId validation + redirect, updated `page.tsx` (remove RegistrationForm wrapper change — the form handles its own section layout).
</objective>

<execution_context>
@/Users/mac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-registration-flow-session-selection/04-RESEARCH.md
@.planning/phases/04-registration-flow-session-selection/04-01-SUMMARY.md
@src/components/intro/registration-form.tsx
@src/actions/register.ts
@src/lib/schemas/registration.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build SessionPicker client component</name>
  <files>src/components/intro/session-picker.tsx</files>
  <action>
Create `src/components/intro/session-picker.tsx` as a `"use client"` component.

Component interface:
```typescript
interface Props {
  selectedId: string | null
  onSelect: (sessionId: string) => void
}
```

Render `introTalkSessions` (imported from `@/lib/data/intro-talks`) as a responsive card grid:
- Mobile: single column (`grid-cols-1`)
- Tablet+: 2-3 columns based on session count (`sm:grid-cols-2 lg:grid-cols-3`)

Each session card is a `<button type="button">` (not a form submit) with:
- `aria-pressed={isSelected}` for accessibility
- Selected state: `border-2 border-primary bg-primary/5 shadow-md`
- Unselected state: `border-2 border-border bg-card hover:border-primary/40`
- Transition: `transition-all duration-150`
- Padding: `p-4` with `rounded-xl`

Card content layout (top to bottom):
1. If `session.badge`: `<Badge variant="secondary" className="mb-2 text-xs">{session.badge}</Badge>` (import Badge from `@/components/ui/badge`)
2. `<p className="font-semibold text-sm">{session.date}</p>`
3. `<p className="text-muted-foreground text-sm">{session.time} {session.timezone}</p>`

When selected, show a checkmark in top-right corner (absolute positioned):
```tsx
{isSelected && (
  <Check className="absolute top-3 right-3 h-4 w-4 text-primary" />
)}
```
(import `Check` from `lucide-react`)

The card button itself needs `className="relative ..."` for the absolute checkmark to work.

Add a section label above the grid:
```tsx
<div>
  <h3 className="text-base font-semibold mb-1">Choose your session</h3>
  <p className="text-sm text-muted-foreground mb-3">Select a date that works for you</p>
  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
    {/* cards */}
  </div>
</div>
```
  </action>
  <verify>
    <automated>cd "/Users/mac/Documents/Art of Living Landing Page" && npx tsc --noEmit 2>&1 | grep -i "session-picker" || echo "No type errors in session-picker"</automated>
    <manual>File exists, exports SessionPicker, has "use client", renders button cards with aria-pressed</manual>
  </verify>
  <done>
    `session-picker.tsx` exists, exports `SessionPicker`, TypeScript checks pass. Component renders session cards with selected/unselected visual states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire session picker into registration form with hidden input and server action redirect</name>
  <files>src/components/intro/registration-form.tsx, src/actions/register.ts, src/lib/schemas/registration.ts</files>
  <action>
This task has three interconnected changes that must be made together.

**Part A — registration-form.tsx:**

The form is already a `"use client"` component using `useActionState`. Add `selectedSessionId` state:

```typescript
const [selectedSessionId, setSelectedSessionId] = useState<string | null>(null)
```

Inside the `<form action={formAction}>`, add a hidden input immediately before the submit button:
```tsx
<input type="hidden" name="sessionId" value={selectedSessionId ?? ""} />
```

Render `SessionPicker` ABOVE the form's `<Card>` component (outside the card, inside the `<section>`), passing state down:
```tsx
<SessionPicker
  selectedId={selectedSessionId}
  onSelect={setSelectedSessionId}
/>
```

Add a `<div className="h-6" />` spacer between the SessionPicker and the Card to create visual breathing room.

If no session is selected and the form is submitted, show a validation error. The server action will catch this — but also add client-side guard: if `selectedSessionId` is null and user attempts to submit, show an inline error message below the session picker: `<p className="text-sm text-destructive mt-2">Please select a session to continue.</p>`. Show this only when `state.errors?.sessionId` exists.

Import: `import { SessionPicker } from "@/components/intro/session-picker"` and `import { useState } from "react"`.

**Part B — src/lib/schemas/registration.ts:**

Add `sessionId` to the registration Zod schema:
```typescript
sessionId: z.string().min(1, "Please select a session"),
```
This ensures the server action validates it before attempting redirect.

**Part C — src/actions/register.ts:**

1. Add `sessionId: formData.get("sessionId") as string` to the `raw` object
2. The schema now includes `sessionId`, so `result.data.sessionId` is available after `safeParse`
3. Add the redirect AFTER the validation block and OUTSIDE any try/catch:
```typescript
// redirect() must be outside try/catch — it throws a NEXT_REDIRECT control-flow exception
redirect(`/intro/confirmation?session=${encodeURIComponent(result.data.sessionId)}`)
```
4. Import `redirect` from `"next/navigation"` at the top
5. Remove the `return { success: true, message: "..." }` that currently exists — the redirect replaces it

CRITICAL: The existing action uses early returns (no try/catch), so `redirect()` can be placed directly at the end. Do not wrap it in try/catch at any point.
  </action>
  <verify>
    <automated>cd "/Users/mac/Documents/Art of Living Landing Page" && npm run build 2>&1 | tail -20</automated>
    <manual>
      1. Visit /intro in dev server
      2. Scroll to registration form — confirm 3 session cards appear above the form card
      3. Click a session card — confirm it highlights with primary border + checkmark
      4. Click another session — confirm selection switches (only one can be selected)
      5. Submit the form with a session selected — confirm page navigates to /intro/confirmation?session=...
    </manual>
  </verify>
  <done>
    Session picker renders above registration form with 3 session cards. Selecting a card highlights it and persists through any validation errors. Successful form submission redirects to `/intro/confirmation?session={id}`. `npm run build` passes clean.
  </done>
</task>

</tasks>

<verification>
`npm run build` passes with zero errors.
`grep -r "redirect" src/actions/register.ts` confirms redirect() is present and outside try/catch.
`grep -r "sessionId" src/components/intro/registration-form.tsx` confirms hidden input exists.
`grep -r "SessionPicker" src/components/intro/registration-form.tsx` confirms component is rendered.
</verification>

<success_criteria>
- 3 session cards render above the registration form on /intro
- Cards are responsive: stacked mobile, row on tablet+
- Selected card has primary border + checkmark icon; only one card selected at a time
- Session selection state persists if form validation fails
- Successful form submission navigates to /intro/confirmation?session={sessionId}
- No session selected + submit shows sessionId validation error
- `npm run build` clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-registration-flow-session-selection/04-02-SUMMARY.md`
</output>
