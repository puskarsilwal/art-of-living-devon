---
phase: 04-registration-flow-session-selection
plan: "03"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/app/(landing)/intro/confirmation/page.tsx
  - src/app/api/calendar/[sessionId]/route.ts
  - package.json
autonomous: true
requirements:
  - INTRO-10

must_haves:
  truths:
    - "After registering, visitor sees a confirmation page at /intro/confirmation?session={id}"
    - "Confirmation page shows: success heading, session date/time, a prominent 'Join Zoom' button"
    - "Confirmation page has two calendar add options side-by-side: 'Add to Google Calendar' and 'Download .ics'"
    - "ICS download at /api/calendar/{sessionId} returns a valid .ics file that opens in calendar apps"
    - "Visiting the confirmation page with an invalid session ID renders the 404 page (not a crash)"
    - "Confirmation page has no navigation, header, or footer — focused and distraction-free"
  artifacts:
    - path: "src/app/(landing)/intro/confirmation/page.tsx"
      provides: "Confirmation page reading searchParams, rendering Zoom link + calendar options"
      exports: ["default"]
    - path: "src/app/api/calendar/[sessionId]/route.ts"
      provides: "Route Handler serving ICS file download"
      exports: ["GET"]
  key_links:
    - from: "src/app/(landing)/intro/confirmation/page.tsx"
      to: "src/lib/data/intro-talks.ts"
      via: "introTalkSessions.find(s => s.id === session) to resolve session data"
      pattern: "introTalkSessions.find"
    - from: "src/app/(landing)/intro/confirmation/page.tsx"
      to: "/api/calendar/[sessionId]"
      via: "icsDownloadUrl = /api/calendar/{session.id} as href on Download .ics button"
      pattern: "/api/calendar"
    - from: "src/app/api/calendar/[sessionId]/route.ts"
      to: "ics (npm package)"
      via: "createEvent() call to generate RFC-5545 compliant ICS string"
      pattern: "createEvent"
---

<objective>
Build the confirmation page and ICS download route handler — the post-registration experience where visitors get everything they need to show up to the session.

Purpose: INTRO-10 requires the confirmation page with Zoom link and calendar add buttons (Google + ICS). This plan creates the page (Server Component, reads searchParams) and the ICS Route Handler, and installs the `ics` npm package.

Output: `confirmation/page.tsx`, `api/calendar/[sessionId]/route.ts`, `ics` package installed.
</objective>

<execution_context>
@/Users/mac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-registration-flow-session-selection/04-RESEARCH.md
@.planning/phases/04-registration-flow-session-selection/04-01-SUMMARY.md
@src/lib/data/intro-talks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ics package and build ICS Route Handler</name>
  <files>src/app/api/calendar/[sessionId]/route.ts, package.json</files>
  <action>
First, install the `ics` package:
```bash
cd "/Users/mac/Documents/Art of Living Landing Page" && npm install ics
```

Then create `src/app/api/calendar/[sessionId]/route.ts`:

```typescript
import { NextResponse } from "next/server"
import { createEvent } from "ics"
import { introTalkSessions } from "@/lib/data/intro-talks"

export async function GET(
  _request: Request,
  { params }: { params: Promise<{ sessionId: string }> }
) {
  const { sessionId } = await params
  const session = introTalkSessions.find(s => s.id === sessionId)
  if (!session) {
    return new Response("Session not found", { status: 404 })
  }

  const start = new Date(session.dateISO)
  const { error, value } = createEvent({
    title: session.title,
    start: [
      start.getUTCFullYear(),
      start.getUTCMonth() + 1,
      start.getUTCDate(),
      start.getUTCHours(),
      start.getUTCMinutes(),
    ],
    startInputType: "utc",
    duration: { hours: 1 },
    description: `Join via Zoom: ${session.zoomUrl}\n\nA free 60-minute introduction to SKY Breath Meditation and the Art of Living. No experience needed.`,
    location: session.zoomUrl,
    url: session.zoomUrl,
    status: "CONFIRMED",
    busyStatus: "BUSY",
  })

  if (error || !value) {
    return new Response("Failed to generate calendar file", { status: 500 })
  }

  return new Response(value, {
    headers: {
      "Content-Type": "text/calendar; charset=utf-8",
      "Content-Disposition": `attachment; filename="art-of-living-intro-${session.id}.ics"`,
      "Cache-Control": "no-store",
    },
  })
}
```

Note: In Next.js 15/16, route handler `params` is a Promise — must be awaited (same as page searchParams). Use `{ params }: { params: Promise<{ sessionId: string }> }` and `const { sessionId } = await params`.

Both `Content-Type` AND `Content-Disposition: attachment` headers are required for reliable cross-browser download behavior. Without `attachment`, some browsers render the ICS as text instead of triggering a download.
  </action>
  <verify>
    <automated>cd "/Users/mac/Documents/Art of Living Landing Page" && npx tsc --noEmit 2>&1 | grep -i "calendar" || echo "No type errors in calendar route"</automated>
    <manual>After dev server starts, curl http://localhost:3000/api/calendar/2026-03-08-1000 and confirm Content-Type: text/calendar header and BEGIN:VCALENDAR in body</manual>
  </verify>
  <done>
    Route Handler exists at `src/app/api/calendar/[sessionId]/route.ts`. `ics` package is in `package.json`. TypeScript passes. Route Handler returns ICS content with correct headers for valid session IDs, 404 for unknown IDs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build confirmation page Server Component</name>
  <files>src/app/(landing)/intro/confirmation/page.tsx</files>
  <action>
Create `src/app/(landing)/intro/confirmation/page.tsx` as an async Server Component.

The page lives in the `(landing)` route group which already has no header/footer (per Phase 2 decision). No layout changes needed.

**Page structure (from user CONTEXT.md decisions — locked):**
1. Large success icon + "You're registered!" heading at top
2. Session details: date, time, timezone
3. Prominent "Join Zoom" button
4. Calendar add section: Google Calendar + ICS download side-by-side
5. Short "What to expect" reassurance (1-2 sentences)
6. No navigation, no upsell, no cross-sell

**Full implementation:**

```typescript
import { notFound } from "next/navigation"
import { CheckCircle, Video, Calendar } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Card, CardContent } from "@/components/ui/card"
import { introTalkSessions } from "@/lib/data/intro-talks"

interface Props {
  searchParams: Promise<{ session?: string }>
}

function buildGoogleCalendarUrl(session: (typeof introTalkSessions)[0]): string {
  const startDate = new Date(session.dateISO)
  const endDate = new Date(startDate.getTime() + 60 * 60 * 1000)
  const fmt = (d: Date) =>
    d.toISOString().replace(/[-:]/g, "").replace(/\.\d{3}/, "")
  const params = new URLSearchParams({
    action: "TEMPLATE",
    text: session.title,
    dates: `${fmt(startDate)}/${fmt(endDate)}`,
    details: `Join via Zoom: ${session.zoomUrl}\n\nA free 60-minute introduction to the Art of Living and SKY Breath Meditation.`,
    location: session.zoomUrl,
  })
  return `https://calendar.google.com/calendar/render?${params.toString()}`
}

export default async function ConfirmationPage({ searchParams }: Props) {
  const { session } = await searchParams
  const selectedSession = introTalkSessions.find(s => s.id === session)

  if (!selectedSession) notFound()

  const googleCalendarUrl = buildGoogleCalendarUrl(selectedSession)
  const icsDownloadUrl = `/api/calendar/${selectedSession.id}`

  return (
    <main className="min-h-screen bg-gradient-to-b from-primary/5 via-background to-background flex items-start justify-center px-4 py-16 sm:py-24">
      <div className="max-w-md w-full space-y-8 text-center">

        {/* Success icon + heading */}
        <div className="space-y-3">
          <div className="flex justify-center">
            <CheckCircle className="h-16 w-16 text-primary" strokeWidth={1.5} />
          </div>
          <h1 className="text-2xl sm:text-3xl font-bold tracking-tight">
            You're registered!
          </h1>
          <p className="text-muted-foreground">
            We look forward to seeing you at the intro talk.
          </p>
        </div>

        {/* Session details card */}
        <Card className="border-primary/10 shadow-sm text-left">
          <CardContent className="pt-6 space-y-3">
            <div className="space-y-1">
              <p className="text-xs uppercase tracking-wider text-muted-foreground font-medium">Your session</p>
              <p className="font-semibold">{selectedSession.date}</p>
              <p className="text-muted-foreground">{selectedSession.time} {selectedSession.timezone} · {selectedSession.duration} · Online</p>
            </div>

            {/* Join Zoom — most prominent element */}
            <Button asChild size="lg" className="w-full mt-4 gap-2">
              <a href={selectedSession.zoomUrl} target="_blank" rel="noopener noreferrer">
                <Video className="h-4 w-4" />
                Join Zoom
              </a>
            </Button>
            <p className="text-xs text-muted-foreground text-center">
              Save this link — you'll need it to join the session
            </p>
          </CardContent>
        </Card>

        {/* Calendar add — side by side */}
        <div className="space-y-2">
          <p className="text-sm font-medium">Add to your calendar</p>
          <div className="grid grid-cols-2 gap-3">
            <Button asChild variant="outline" size="sm" className="gap-1.5">
              <a href={googleCalendarUrl} target="_blank" rel="noopener noreferrer">
                <Calendar className="h-4 w-4" />
                Google Calendar
              </a>
            </Button>
            <Button asChild variant="outline" size="sm" className="gap-1.5">
              <a href={icsDownloadUrl}>
                <Calendar className="h-4 w-4" />
                Download .ics
              </a>
            </Button>
          </div>
          <p className="text-xs text-muted-foreground">
            .ics works with Apple Calendar, Outlook, and most calendar apps
          </p>
        </div>

        {/* What to expect reassurance */}
        <div className="text-sm text-muted-foreground border-t pt-6">
          <p>
            The session is 60 minutes online. You'll experience a guided SKY Breath technique,
            a short meditation, and have time for questions. Camera on but no pressure to participate actively.
          </p>
        </div>

      </div>
    </main>
  )
}
```

Add page metadata:
```typescript
export const metadata = {
  title: "You're Registered — Art of Living Devon & Southwest",
  robots: "noindex", // Confirmation page should not be indexed
}
```
  </action>
  <verify>
    <automated>cd "/Users/mac/Documents/Art of Living Landing Page" && npm run build 2>&1 | tail -20</automated>
    <manual>
      1. Navigate to /intro/confirmation?session=2026-03-08-1000 in dev server
      2. Confirm: success icon + "You're registered!" heading at top
      3. Confirm: session details card with date, time, "Join Zoom" button
      4. Confirm: two calendar buttons side-by-side
      5. Navigate to /intro/confirmation?session=invalid — confirm 404 page renders (not crash)
      6. Confirm: no header, no footer, no navigation links on the page
    </manual>
  </verify>
  <done>
    Confirmation page renders at `/intro/confirmation?session=2026-03-08-1000` with: success heading, session details, prominent Zoom button, Google Calendar + .ics download buttons side-by-side, reassurance text. Invalid session IDs show 404. `npm run build` passes clean.
  </done>
</task>

</tasks>

<verification>
`npm run build` passes with zero errors.
`ls src/app/\(landing\)/intro/confirmation/page.tsx` confirms page exists.
`ls src/app/api/calendar/` confirms route directory exists.
`grep "ics" package.json` confirms `ics` dependency installed.
`grep "notFound" src/app/\(landing\)/intro/confirmation/page.tsx` confirms 404 guard present.
`grep "Content-Disposition" src/app/api/calendar/\[sessionId\]/route.ts` confirms attachment header set.
</verification>

<success_criteria>
- `/intro/confirmation?session=2026-03-08-1000` renders with success heading, session card, Zoom button, calendar options
- `/intro/confirmation?session=invalid` renders Next.js 404 (not a crash)
- `/api/calendar/2026-03-08-1000` returns ICS file with correct Content-Type and Content-Disposition headers
- Calendar buttons appear side-by-side (Google Calendar + Download .ics)
- Page has no navigation or footer — stays in (landing) layout
- `npm run build` clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-registration-flow-session-selection/04-03-SUMMARY.md`
</output>
